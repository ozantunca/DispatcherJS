"use strict";!function(){var e={_listeners:[],_maxListeners:10,_parseListener:function(e,t){var n={fn:t};if("function"==typeof e)n.fn=e;else if(Array.isArray(e))n.dependencies=e;else{if("string"!=typeof e)throw Error("EventHandler is not a function.");n.dependencies=[e]}return n},removeAllListeners:function(e){return e||0==e?this.off(e):void(this._listeners=[])},setMaxListeners:function(e){this._maxListeners=e},on:function(e,t,n){this.listeners(e).length<this._maxListeners&&(n=this._parseListener(t,n),n.eventName=e,this._listeners.push(n),"newListener"!=e&&this.emit("newListener",n.fn))},once:function(e,t,n){this.listeners(e).length<this._maxListeners&&(n=this._parseListener(t,n),n.eventName=e,n.once=!0,this._listeners.push(n),"newListener"!=e&&this.emit("newListener",n.fn))},off:function(e,t){if(void 0!==e)if(t)for(var n=this._listeners.length;n--;)e==this._listeners[n].eventName&&this._listeners[n].fn===t&&(this.emit("removeListener",this._listeners[n].fn),this._listeners.splice(n,1));else for(var n=this._listeners.length;n--;)e==this._listeners[n].eventName&&(this.emit("removeListener",this._listeners[n].fn),this._listeners.splice(n,1))},listeners:function(e){if(!e)return this._listeners;var t,n=e.split("."),e=n[0],i=n[1]?"."+n[1]:null,s=[];if(t=i?this._matchWithNamespace:this._matchEvent,"function"==typeof this._listeners.filter)return this._listeners.filter(function(n){return t(e,n.eventName,i)});for(var r=0;r<this._listeners;r++)t(e,listener.eventName,i)&&s.push(listener);return s},_matchWithNamespace:function(e,t,n){return e==t||0==e.indexOf(t+":")||t==n||"*"==t||0==e.indexOf(t.substring(0,t.indexOf("."))+":")},_matchEvent:function(e,t){return e==t||0==e.indexOf(t+":")||0==t.indexOf(e+".")||"*"==t||0==e.indexOf(t.substring(0,t.indexOf("."))+":")},_matchArray:function(e,t){var n,i;if(-1!=t.indexOf(".")){var s=t.split("."),t=s[0],r=s[1]?"."+s[1]:null;n=this._matchWithNamespace}else n=this._matchEvent;for(;i=e.pop();)if(n(t,i.eventName,r)||i.eventName.substring(i.eventName.indexOf("."))==r&&"*"!=i.eventName)return!0;return!1},_deferredLoop:function(e,t,n){var i,s,r,f,o=this,h=0;for(i=h=e.length;s=e.pop();){if(0==h){if(t)return;throw Error("Deadlock!")}if(f=!1,s.dependencies){for(var a=0;a<s.dependencies.length;a++)f=o._matchArray(e.slice(),s.dependencies[a])?!0:f;f?e.unshift(s):(r=s.fn(n),r&&r.then&&(t++,e.unshift(s),r.then(function(){t--,o._deferredLoop(e,t,n)}))),e.length==i?h--:i=h=e.length}else e.unshift(s),h--}},emit:function(e){if(!e)throw Error("Nothing to emit.");var t,n,i,s=[],r=this._listeners.slice(),f=0,o=this,h={arguments:"object"==typeof arguments?Array.prototype.slice.call(arguments,1):[],event:e};if(-1!=e.indexOf(".")){var a=e.split("."),e=a[0],l=a[1]?"."+a[1]:null;n=o._matchWithNamespace}else n=o._matchEvent;if(!e)throw Error("Nothing to emit.");for(;t=r.pop();)if(n(e,t.eventName,l)){if(t.dependencies){s.push(t);continue}i=t.fn(h),i&&i.then&&(f++,s.push(t),i.then(function(){f--,o._deferredLoop(s,f,h)})),t.once&&o._listeners.splice(r.length,1)}s.length>0&&o._deferredLoop(s,f,h)}};e.removeListener=e.off,e.addListener=e.on,"function"==typeof define&&define.amd?define(function(){return e}):"object"==typeof exports?module.exports=e:window.dispatcher=e}();
