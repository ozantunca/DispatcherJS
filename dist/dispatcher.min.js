"use strict";!function(){var e=function(){this._listeners=[],this._maxListeners=10};e.prototype._parseListener=function(e,t){var n={fn:t};if("function"==typeof e)n.fn=e;else if(Array.isArray(e))n.dependencies=e;else{if("string"!=typeof e)throw Error("EventHandler is not a function.");n.dependencies=[e]}return n},e.prototype.removeAllListeners=function(e){return e||0==e?this.off(e):void(this._listeners=[])},e.prototype.setMaxListeners=function(e){this._maxListeners=e},e.prototype.on=function(e,t,n){this.listeners(e).length<this._maxListeners&&(n=this._parseListener(t,n),n.eventName=e,this._listeners.push(n),"newListener"!=e&&this.emit("newListener",n.fn))},e.prototype.once=function(e,t,n){this.listeners(e).length<this._maxListeners&&(n=this._parseListener(t,n),n.eventName=e,n.once=!0,this._listeners.push(n),"newListener"!=e&&this.emit("newListener",n.fn))},e.prototype.off=function(e,t){if(void 0!==e)if(t)for(var n=this._listeners.length;n--;)e==this._listeners[n].eventName&&this._listeners[n].fn===t&&(this.emit("removeListener",this._listeners[n].fn),this._listeners.splice(n,1));else for(var n=this._listeners.length;n--;)e==this._listeners[n].eventName&&(this.emit("removeListener",this._listeners[n].fn),this._listeners.splice(n,1))},e.prototype.listeners=function(e){if(!e)return this._listeners;var t,n=e.split("."),e=n[0],i=n[1]?"."+n[1]:null,s=[];if(t=i?this._matchWithNamespace:this._matchEvent,"function"==typeof this._listeners.filter)return this._listeners.filter(function(n){return t(e,n.eventName,i)});for(var r=0;r<this._listeners;r++)t(e,listener.eventName,i)&&s.push(listener);return s},e.prototype._matchWithNamespace=function(e,t,n){return e==t||0==e.indexOf(t+":")||t==n||"*"==t||0==e.indexOf(t.substring(0,t.indexOf("."))+":")},e.prototype._matchEvent=function(e,t){return e==t||0==e.indexOf(t+":")||0==t.indexOf(e+".")||"*"==t||0==e.indexOf(t.substring(0,t.indexOf("."))+":")},e.prototype._matchArray=function(e,t){var n,i;if(-1!=t.indexOf(".")){var s=t.split("."),t=s[0],r=s[1]?"."+s[1]:null;n=this._matchWithNamespace}else n=this._matchEvent;for(;i=e.pop();)if(n(t,i.eventName,r)||i.eventName.substring(i.eventName.indexOf("."))==r&&"*"!=i.eventName)return!0;return!1},e.prototype._deferredLoop=function(e,t,n){var i,s,r,o,f=this,h=0;for(i=h=e.length;s=e.pop();){if(0==h){if(t)return;throw Error("Deadlock!")}if(o=!1,s.dependencies){for(var p=0;p<s.dependencies.length;p++)o=f._matchArray(e.slice(),s.dependencies[p])?!0:o;o?e.unshift(s):(r=s.fn(n),r&&r.then&&(t++,e.unshift(s),r.then(function(){t--,f._deferredLoop(e,t,n)}))),e.length==i?h--:i=h=e.length}else e.unshift(s),h--}},e.prototype.emit=function(e){if(!e)throw Error("Nothing to emit.");var t,n,i,s=[],r=this._listeners.slice(),o=0,f=this,h={arguments:"object"==typeof arguments?Array.prototype.slice.call(arguments,1):[],event:e};if(-1!=e.indexOf(".")){var p=e.split("."),e=p[0],a=p[1]?"."+p[1]:null;n=f._matchWithNamespace}else n=f._matchEvent;if(!e)throw Error("Nothing to emit.");for(;t=r.pop();)if(n(e,t.eventName,a)){if(t.dependencies){s.push(t);continue}i=t.fn(h),i&&i.then&&(o++,s.push(t),i.then(function(){o--,f._deferredLoop(s,o,h)})),t.once&&f._listeners.splice(r.length,1)}s.length>0&&f._deferredLoop(s,o,h)},e.prototype.removeListener=e.off,e.prototype.addListener=e.on,"object"==typeof exports?module.exports=e:"function"==typeof define&&define.amd?define(function(){return e}):window.Dispatcher=e}();
