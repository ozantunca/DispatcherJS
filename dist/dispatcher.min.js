"use strict";!function(){var e={each:function(e,t){for(var n=e.length;0!==n--;)t(e[n],n)}},t=function(){this._listeners=[],this._maxListeners=10};t.prototype._parseListener=function(e,t){var n={fn:t};if("function"==typeof e)n.fn=e;else if(Array.isArray(e))n.dependencies=e;else{if("string"!=typeof e)throw Error("EventHandler is not a function.");n.dependencies=[e]}return n},t.prototype.removeAllListeners=function(e){return e||0==e?this.off(e):void(this._listeners=[])},t.prototype.setMaxListeners=function(e){this._maxListeners=e},t.prototype.on=function(e,t,n){"string"!=typeof e&&(e=""+e),this.listeners(e).length<this._maxListeners&&(n=this._parseListener(t,n),n.eventName=e,this._listeners.push(n),"newListener"!=e&&this.emit("newListener",n.fn))},t.prototype.once=function(e,t,n){this.listeners(e).length<this._maxListeners&&(n=this._parseListener(t,n),n.eventName=e,n.once=!0,this._listeners.push(n),"newListener"!=e&&this.emit("newListener",n.fn))},t.prototype.off=function(e,t){if(void 0!==e)if(t)for(var n=this._listeners.length;n--;)e==this._listeners[n].eventName&&this._listeners[n].fn===t&&(this.emit("removeListener",this._listeners[n].fn),this._listeners.splice(n,1));else for(var n=this._listeners.length;n--;)e==this._listeners[n].eventName&&(this.emit("removeListener",this._listeners[n].fn),this._listeners.splice(n,1))},t.prototype.listeners=function(e){if(!e)return this._listeners;var t,n=e.split("."),e=n[0],i=n[1]?"."+n[1]:null,r=[];if(t=i?this._matchWithNamespace:this._matchEvent,"function"==typeof this._listeners.filter)return this._listeners.filter(function(n){return t(e,n.eventName,i)});for(var s=0;s<this._listeners;s++)t(e,listener.eventName,i)&&r.push(listener);return r},t.prototype._matchWithNamespace=function(e,t,n){return e==t||e+n==t||0==e.indexOf(t+":")||t==n||"*"==t||0==e.indexOf(t.substring(0,t.indexOf("."))+":")},t.prototype._matchEvent=function(e,t){return e==t||0==e.indexOf(t+":")||0==t.indexOf(e+".")||"*"==t||0==e.indexOf(t.substring(0,t.indexOf("."))+":")},t.prototype._matchArray=function(e,t){var n,i;if(-1!=t.indexOf(".")){var r=t.split("."),t=r[0],s=r[1]?"."+r[1]:null;n=this._matchWithNamespace}else n=this._matchEvent;for(;i=e.pop();)if(n(t,i.eventName,s)||i.eventName.substring(i.eventName.indexOf("."))==s&&"*"!=i.eventName)return!0;return!1},t.prototype._deferredLoop=function(e,t,n){var i,r,s,o,f=this,h=0;for(i=h=e.length;r=e.pop();){if(0==h){if(t)return;throw Error("Deadlock!")}if(o=!1,r.dependencies){for(var p=0;p<r.dependencies.length;p++)o=f._matchArray(e.slice(),r.dependencies[p])?!0:o;o?e.unshift(r):(s=r.fn(n),s&&s.then&&(t++,e.unshift(r),s.then(function(){t--,f._deferredLoop(e,t,n)}))),e.length==i?h--:i=h=e.length}else e.unshift(r),h--}},t.prototype.emit=function(t){if(!t)throw Error("Nothing to emit.");"string"!=typeof t&&(t=""+t);var n,i,r=[],s=this._listeners.slice(),o=0,f=this,h={arguments:"object"==typeof arguments?Array.prototype.slice.call(arguments,1):[],event:t,stopPropagation:function(){s=[],r=[]}};if(-1!=t.indexOf(".")){var p=t.split("."),t=p[0],a=p[1]?"."+p[1]:null;n=f._matchWithNamespace}else n=f._matchEvent;if(!t)throw Error("Nothing to emit.");e.each(s,function(e,s){if(n(t,e.eventName,a)){if(e.dependencies)return void r.push(e);i=e.fn(h),i&&i.then&&(o++,r.push(e),i.then(function(){o--,f._deferredLoop(r,o,h)})),e.once&&f._listeners.splice(s,1)}}),r.length>0&&f._deferredLoop(r,o,h)},t.prototype.applyEmit=function(e){var t=this,n="object"==typeof arguments?Array.prototype.slice.call(arguments,1):[];return n.unshift(e),function(){t.emit.apply(t,n)}},t.prototype.removeListener=t.off,t.prototype.addListener=t.on,"object"==typeof exports?module.exports=t:"function"==typeof define&&define.amd?define(function(){return t}):window.Dispatcher=t}();
