"use strict";!function(){var e={_listeners:[],_parseListener:function(e,t){if("function"==typeof e)t=e;else if(Array.isArray(e))t.dependencies=e;else{if("string"!=typeof e)throw Error("EventHandler is not a function.");t.dependencies=[e]}return t},removeAllListeners:function(e){return e||0==e?this.off(e):void(this._listeners=[])},on:function(e,t,n){n=this._parseListener(t,n),n.eventName=e,this._listeners.push(n)},once:function(e,t,n){n=this._parseListener(t,n),n.eventName=e,n.once=!0,this._listeners.push(n)},off:function(e,t){if(void 0!==e)if(t)for(var n=0;n<this._listeners.length;n++)e==this._listeners[n].eventName&&this._listeners[n]===t&&this._listeners.splice(n,1);else for(var n=0;n<this._listeners.length;n++)e==this._listeners[n].eventName&&this._listeners.splice(n,1)},listeners:function(e){var t=e.split("."),e=t[0],n=t[1]?"."+t[1]:null,i=[];if(_match=n?this._matchWithNamespace:this._matchEvent,"function"==typeof this._listeners.filter)return this._listeners.filter(function(t){_match(e,t.eventName,n)});for(var s=0;s<this._listeners;s++)_match(e,listener.eventName,n)&&i.push(listener);return i},_matchWithNamespace:function(e,t,n){return e==t||0==e.indexOf(t+":")||t==n||"*"==t},_matchEvent:function(e,t){return e==t||0==e.indexOf(t+":")||0==t.indexOf(e+".")||"*"==t},_matchArray:function(e,t){var n,i;if(-1!=t.indexOf(".")){var s=t.split("."),t=s[0],r=s[1]?"."+s[1]:null;n=this._matchWithNamespace}else n=this._matchEvent;for(;i=e.pop();)if(n(t,i.eventName,r)||i.eventName.substring(i.eventName.indexOf("."))==r&&"*"!=i.eventName)return!0;return!1},_deferredLoop:function(e,t){var n,i,s,r,o=this,f=0;for(n=f=e.length;i=e.pop();){if(0==f){if(t)return;throw Error("Deadlock!")}if(r=!1,i.dependencies){for(var h=0;h<i.dependencies.length;h++)r=o._matchArray(e.slice(),i.dependencies[h])?!0:r;r?e.unshift(i):(s=arguments.length>1?i.apply(null,arguments):i(),s&&s.then&&(t++,e.unshift(i),s.then(function(){t--,o._deferredLoop(e,t)}))),e.length==n?f--:n=f=e.length}else e.unshift(i),f--}},emit:function(e){if(!e)throw Error("Nothing to emit.");var t,n,i,s=[],r=this._listeners.slice(),o=0,f=this;if(-1!=e.indexOf(".")){var h=e.split("."),e=h[0],l=h[1]?"."+h[1]:null;n=f._matchWithNamespace}else n=f._matchEvent;if(!e)throw Error("Nothing to emit.");for(;t=r.pop();){if(n(e,t.eventName,l)){if(t.dependencies){s.push(t);continue}i=arguments.length>1?t.apply(null,arguments):t(),i&&i.then&&(o++,s.push(t),i.then(function(){o--,f._deferredLoop(s,o)}))}t.once&&f._listeners.splice(r.length,1)}s.length>0&&f._deferredLoop(s,o)}};e.removeListener=e.off,e.addListener=e.on,module.exports=e,"function"==typeof define&&define.amd?define(function(){return e}):"object"==typeof exports?module.exports=e:window.dispatcher=e}();
